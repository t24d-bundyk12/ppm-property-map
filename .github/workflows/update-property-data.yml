name: Update Property Data

on:
  workflow_dispatch:
  repository_dispatch:
    types: [update-property-data]

permissions:
  contents: write
  
jobs:
  update-map:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Process Property Data
        run: |
          echo "=== RECEIVED DATA ==="
          echo "Property ID: '${{ github.event.client_payload.prop_id }}'"
          echo "Address: '${{ github.event.client_payload.address }}'"
          echo "Record ID: '${{ github.event.client_payload.record_id }}'"
          
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: Update Property JSON File
        run: |
          cat > update_properties.js << 'EOF'
          const fs = require('fs');
          
          // Get the updated property data from GitHub payload
          const propId = process.env.PROP_ID;
          const updatedProperty = {
            id: propId,
            address: process.env.ADDRESS,
            coordinates: { lat: 0, lng: 0 },
            maintenance: {
              lockbox_pickup: process.env.LOCKBOX_STATUS,
              banner_pickup: process.env.BANNER_STATUS,
              exterior_photos: process.env.PHOTOS_STATUS,
              eyes_on_property: process.env.EYES_ON_PROP,
              earliest_pickup_date: process.env.PICKUP_DATE
            },
            status: "updated",
            last_updated: new Date().toISOString()
          };
          
          console.log(`Processing property with ID: "${propId}" (type: ${typeof propId})`);
          
          let data;
          
          // Read existing file or create new structure
          try {
            const fileContent = fs.readFileSync('property-data.json', 'utf8');
            data = JSON.parse(fileContent);
            console.log(`Existing file has ${data.properties.length} properties`);
            console.log(`Existing property IDs: ${data.properties.map(p => `"${p.id}"`).join(', ')}`);
          } catch (error) {
            console.log('Creating new property data file');
            data = { properties: [], last_updated: "" };
          }
          
          // Find existing property with better matching
          const existingIndex = data.properties.findIndex(p => {
            console.log(`Comparing "${p.id}" (${typeof p.id}) with "${propId}" (${typeof propId})`);
            return String(p.id) === String(propId);
          });
          
          if (existingIndex !== -1) {
            // Update existing property
            data.properties[existingIndex] = updatedProperty;
            console.log(`✅ UPDATED existing property at index ${existingIndex}: ${propId}`);
          } else {
            // Add new property
            data.properties.push(updatedProperty);
            console.log(`✅ ADDED new property: ${propId}`);
          }
          
          // Update timestamp
          data.last_updated = new Date().toISOString();
          
          // Write updated file
          fs.writeFileSync('property-data.json', JSON.stringify(data, null, 2));
          
          console.log(`=== FINAL RESULT ===`);
          console.log(`Total properties in file: ${data.properties.length}`);
          console.log(`Property IDs now in file: ${data.properties.map(p => `"${p.id}"`).join(', ')}`);
          EOF
          
          # Run the update script with environment variables
          PROP_ID="${{ github.event.client_payload.prop_id }}" \
          ADDRESS="${{ github.event.client_payload.address }}" \
          LOCKBOX_STATUS="${{ github.event.client_payload.lockbox_status }}" \
          BANNER_STATUS="${{ github.event.client_payload.banner_status }}" \
          PHOTOS_STATUS="${{ github.event.client_payload.photos_status }}" \
          EYES_ON_PROP="${{ github.event.client_payload.eyes_on_prop }}" \
          PICKUP_DATE="${{ github.event.client_payload.pickup_date }}" \
          node update_properties.js
          
      - name: Commit Updated Data
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add property-data.json
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update property data: Property ${{ github.event.client_payload.prop_id }}"
            git push
          fi
