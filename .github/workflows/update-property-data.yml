name: Update Property Data

on:
  workflow_dispatch:
  repository_dispatch:
    types: [update-property-data]

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
  
jobs:
  update-map:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Process All Property Data
        run: |
          echo "=== RECEIVED COMPLETE DATASET ==="
          echo "Action: '${{ github.event.client_payload.action }}'"
          echo "Total Properties: '${{ github.event.client_payload.count }}'"
          echo "Trigger Record: '${{ github.event.client_payload.trigger_record_id }}'"
          
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: Replace Complete Property Dataset
        run: |
          cat > replace_all_properties.js << 'EOF'
          const fs = require('fs');
          
          // Helper function to parse comma-separated strings into arrays
          function parseToArray(envVar) {
            if (!envVar) return [];
            
            try {
              // First try to parse as JSON (in case it's already an array)
              const parsed = JSON.parse(envVar);
              if (Array.isArray(parsed)) {
                return parsed;
              }
              // If it's a string, split by commas, trim whitespace, and filter out empty values
              return String(parsed)
                .split(',')
                .map(item => item.trim())
                .filter(item => item !== ''); // This removes empty strings from consecutive commas
            } catch (error) {
              // If JSON.parse fails, treat as comma-separated string
              return String(envVar)
                .split(',')
                .map(item => item.trim())
                .filter(item => item !== ''); // This removes empty strings from consecutive commas
            }
          }
          
          // Parse all property arrays from GitHub payload
          const propIds = parseToArray(process.env.PROP_IDS);
          const addresses = parseToArray(process.env.ADDRESSES);
          const lockboxStatuses = parseToArray(process.env.LOCKBOX_STATUSES);
          const bannerStatuses = parseToArray(process.env.BANNER_STATUSES);
          const photosStatuses = parseToArray(process.env.PHOTOS_STATUSES);
          const eyesOnProp = parseToArray(process.env.EYES_ON_PROP);
          const pickupDates = parseToArray(process.env.PICKUP_DATES);
          const recordIds = parseToArray(process.env.RECORD_IDS);
          
          console.log(`Processing ${propIds.length} properties from complete dataset`);
          console.log(`Raw PROP_IDS: ${process.env.PROP_IDS}`);
          console.log(`Parsed Property IDs: [${propIds.join(', ')}]`);
          
          // Build complete property array
          const properties = [];
          
          for (let i = 0; i < propIds.length; i++) {
            properties.push({
              id: propIds[i],
              address: addresses[i] || '',
              coordinates: { lat: 0, lng: 0 },
              maintenance: {
                lockbox_pickup: lockboxStatuses[i] || 'Unknown',
                banner_pickup: bannerStatuses[i] || 'Unknown', 
                exterior_photos: photosStatuses[i] || 'Unknown',
                eyes_on_property: eyesOnProp[i] || 'Unknown',
                earliest_pickup_date: pickupDates[i] || null
              },
              zapier_record_id: recordIds[i] || '',
              status: "current",
              last_updated: new Date().toISOString()
            });
          }
          
          // Create complete new dataset
          const completeData = {
            properties: properties,
            last_updated: new Date().toISOString(),
            sync_info: {
              action: process.env.ACTION || 'full_table_sync',
              trigger_record_id: process.env.TRIGGER_RECORD_ID || '',
              total_properties: properties.length,
              sync_timestamp: new Date().toISOString()
            }
          };
          
          // Write complete dataset (replaces entire file)
          fs.writeFileSync('property-data.json', JSON.stringify(completeData, null, 2));
          
          console.log(`âœ… COMPLETE DATASET REPLACED`);
          console.log(`Total properties: ${properties.length}`);
          console.log(`First few property IDs: ${propIds.slice(0, 3).join(', ')}${propIds.length > 3 ? '...' : ''}`);
          console.log(`Sync completed at: ${completeData.last_updated}`);
          EOF
          
          # Run the replacement script with all property arrays
          PROP_IDS='${{ toJson(github.event.client_payload.properties.prop_ids) }}' \
          ADDRESSES='${{ toJson(github.event.client_payload.properties.addresses) }}' \
          LOCKBOX_STATUSES='${{ toJson(github.event.client_payload.properties.lockbox_pickup) }}' \
          BANNER_STATUSES='${{ toJson(github.event.client_payload.properties.banner_pickup) }}' \
          PHOTOS_STATUSES='${{ toJson(github.event.client_payload.properties.photos_needed) }}' \
          EYES_ON_PROP='${{ toJson(github.event.client_payload.properties.eyes_on_property) }}' \
          PICKUP_DATES='${{ toJson(github.event.client_payload.properties.pickup_dates) }}' \
          RECORD_IDS='${{ toJson(github.event.client_payload.properties.record_ids) }}' \
          ACTION='${{ github.event.client_payload.action }}' \
          TRIGGER_RECORD_ID='${{ github.event.client_payload.trigger_record_id }}' \
          node replace_all_properties.js
          
      - name: Commit Complete Dataset
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add property-data.json
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Complete property dataset sync: ${{ github.event.client_payload.count }} properties updated"
            git push
          fi
