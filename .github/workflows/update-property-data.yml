name: Update Property Data

on:
  workflow_dispatch:
  repository_dispatch:
    types: [update-property-data]

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
  
jobs:
  update-map:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Process All Property Data
        run: |
          echo "=== RECEIVED COMPLETE DATASET ==="
          echo "Action: '${{ github.event.client_payload.action }}'"
          echo "Total Properties: '${{ github.event.client_payload.count }}'"
          echo "Trigger Record: '${{ github.event.client_payload.trigger_record_id }}'"
          
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: Replace Complete Property Dataset
        run: |
          cat > replace_all_properties.js << 'EOF'
          const fs = require('fs');
          
          // Get all property arrays from GitHub payload
          const propIds = process.env.PROP_IDS ? JSON.parse(process.env.PROP_IDS) : [];
          const addresses = process.env.ADDRESSES ? JSON.parse(process.env.ADDRESSES) : [];
          const lockboxStatuses = process.env.LOCKBOX_STATUSES ? JSON.parse(process.env.LOCKBOX_STATUSES) : [];
          const bannerStatuses = process.env.BANNER_STATUSES ? JSON.parse(process.env.BANNER_STATUSES) : [];
          const photosStatuses = process.env.PHOTOS_STATUSES ? JSON.parse(process.env.PHOTOS_STATUSES) : [];
          const eyesOnProp = process.env.EYES_ON_PROP ? JSON.parse(process.env.EYES_ON_PROP) : [];
          const pickupDates = process.env.PICKUP_DATES ? JSON.parse(process.env.PICKUP_DATES) : [];
          const recordIds = process.env.RECORD_IDS ? JSON.parse(process.env.RECORD_IDS) : [];
          
          console.log(`Processing ${propIds.length} properties from complete dataset`);
          
          // Build complete property array
          const properties = [];
          
          for (let i = 0; i < propIds.length; i++) {
            properties.push({
              id: propIds[i],
              address: addresses[i] || '',
              coordinates: { lat: 0, lng: 0 },
              maintenance: {
                lockbox_pickup: lockboxStatuses[i] || 'Unknown',
                banner_pickup: bannerStatuses[i] || 'Unknown', 
                exterior_photos: photosStatuses[i] || 'Unknown',
                eyes_on_property: eyesOnProp[i] || 'Unknown',
                earliest_pickup_date: pickupDates[i] || null
              },
              zapier_record_id: recordIds[i] || '',
              status: "current",
              last_updated: new Date().toISOString()
            });
          }
          
          // Create complete new dataset
          const completeData = {
            properties: properties,
            last_updated: new Date().toISOString(),
            sync_info: {
              action: process.env.ACTION || 'full_table_sync',
              trigger_record_id: process.env.TRIGGER_RECORD_ID || '',
              total_properties: properties.length,
              sync_timestamp: new Date().toISOString()
            }
          };
          
          // Write complete dataset (replaces entire file)
          fs.writeFileSync('property-data.json', JSON.stringify(completeData, null, 2));
          
          console.log(`âœ… COMPLETE DATASET REPLACED`);
          console.log(`Total properties: ${properties.length}`);
          console.log(`Property IDs: ${propIds.join(', ')}`);
          console.log(`Sync completed at: ${completeData.last_updated}`);
          EOF
          
          # Run the replacement script with all property arrays
          PROP_IDS='${{ toJson(github.event.client_payload.prop_ids) }}' \
          ADDRESSES='${{ toJson(github.event.client_payload.addresses) }}' \
          LOCKBOX_STATUSES='${{ toJson(github.event.client_payload.lockbox_pickup) }}' \
          BANNER_STATUSES='${{ toJson(github.event.client_payload.banner_pickup) }}' \
          PHOTOS_STATUSES='${{ toJson(github.event.client_payload.photos_needed) }}' \
          EYES_ON_PROP='${{ toJson(github.event.client_payload.eyes_on_property) }}' \
          PICKUP_DATES='${{ toJson(github.event.client_payload.pickup_dates) }}' \
          RECORD_IDS='${{ toJson(github.event.client_payload.record_ids) }}' \
          ACTION='${{ github.event.client_payload.action }}' \
          TRIGGER_RECORD_ID='${{ github.event.client_payload.trigger_record_id }}' \
          node replace_all_properties.js
          
      - name: Commit Complete Dataset
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add property-data.json
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Complete property dataset sync: ${{ github.event.client_payload.total_properties }} properties updated"
            git push
          fi
