<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>PPM Property Map</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <style>
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        .legend {
            position: absolute; bottom: 30px; left: 10px; z-index: 1000;
            background: white; padding: 10px; border-radius: 6px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); font-size: 12px;
        }
        .legend-item { margin: 2px 0; display: flex; align-items: center; }
        .legend-color { width: 12px; height: 12px; border-radius: 50%; margin-right: 6px; }
        .debug { 
            position: absolute; top: 10px; left: 10px; z-index: 1000;
            background: white; padding: 8px; border-radius: 4px; font-size: 11px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div id="debug" class="debug">Loading...</div>
    
    <div class="legend">
        <strong>Property Status</strong>
        <div class="legend-item">
            <div class="legend-color" style="background: #ff0000;"></div>
            Lockbox Needed
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #ffff00; border: 1px solid #ccc;"></div>
            Photos Needed
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #0000ff;"></div>
            Eyes-On Needed
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #00ff00;"></div>
            Banner/Sign Needed
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #808080;"></div>
            N/A
        </div>
    </div>
    
    <div id="map"></div>
    
    <script>
        mapboxgl.accessToken = 'pk.eyJ1IjoiYnVuZHlrMTIiLCJhIjoiY21oY2NuZWMwMjEycDJucTMyM3B6dXJxZyJ9.eaWSaIsHytWE8odV_Lnhmg';
        
        const debugDiv = document.getElementById('debug');
        const TABLE_ID = '01K8STKYM0BNQ3HDCQ0YXDDZJS';
        
        debugDiv.textContent = 'Initializing map...';
        
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v12',
            center: [-104.9903, 39.7392], // Denver coordinates
            zoom: 11
        });

        // Function to determine color based on property status
        function getPropertyColor(record) {
            // Using correct field IDs - only show status when 'needed'
            const lockboxNeeded = record.f3 === 'needed';     // Field 3: Lockbox Removal Status
            const photosNeeded = record.f7 === 'needed';      // Field 7: Exterior Photos Status
            const eyesOnNeeded = record.f8 === 'needed';      // Field 8: Eyes-On-Property Status
            const bannerNeeded = record.f5 === 'needed';      // Field 5: Banner/Yard Sign Removal Status
            
            // Priority order: Red > Yellow > Blue > Green > Gray
            if (lockboxNeeded) return { color: '#ff0000', status: 'Lockbox Removal Needed' };
            if (photosNeeded) return { color: '#ffff00', status: 'Exterior Photos Needed' };
            if (eyesOnNeeded) return { color: '#0000ff', status: 'Eyes-On Property Needed' };
            if (bannerNeeded) return { color: '#00ff00', status: 'Banner/Sign Removal Needed' };
            
            // Everything else shows as N/A (completed, scheduled, na, etc.)
            return { color: '#808080', status: 'N/A' };
        }

        // Function to fetch data from Zapier Tables
        async function fetchTableData() {
            try {
                debugDiv.textContent = 'Fetching property data...';
                
                // Zapier Tables API endpoint
                const response = await fetch(`https://tables.zapier.com/api/v1/tables/${TABLE_ID}/records`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('API Response:', data);
                
                return data.records || [];
                
            } catch (error) {
                console.error('Error fetching table data:', error);
                debugDiv.textContent = 'Error loading data - using test data';
                debugDiv.style.background = '#fff3cd';
                debugDiv.style.color = '#856404';
                
                // Fallback to test data if API fails
                return [
                    { f1: 'Test Property 1', f11: 39.7391, f12: -104.9847, f3: 'needed', f7: 'completed', f8: 'na', f5: 'na' },
                    { f1: 'Test Property 2', f11: 39.7531, f12: -104.9803, f3: 'completed', f7: 'needed', f8: 'na', f5: 'na' },
                    { f1: 'Test Property 3', f11: 39.7392, f12: -104.9903, f3: 'na', f7: 'completed', f8: 'needed', f5: 'na' }
                ];
            }
        }

        // Add markers to map
        async function loadProperties() {
            try {
                const records = await fetchTableData();
                console.log(`Processing ${records.length} records`);
                
                let markersAdded = 0;
                let validRecords = 0;
                
                records.forEach((record, index) => {
                    // Extract coordinates - correct field numbers
                    const lat = parseFloat(record.f11); // Field 11: Latitude
                    const lng = parseFloat(record.f12); // Field 12: Longitude
                    const name = record.f1 || `Property ${index + 1}`; // Field 1: Property Address
                    
                    // Skip records without valid coordinates
                    if (!lat || !lng || isNaN(lat) || isNaN(lng)) {
                        console.log(`Skipping record ${index + 1}: invalid coordinates`, { lat, lng });
                        return;
                    }
                    
                    validRecords++;
                    
                    try {
                        const { color, status } = getPropertyColor(record);
                        
                        console.log(`Adding marker for: ${name} at ${lat}, ${lng} - ${status}`);
                        
                        // Create marker
                        const marker = new mapboxgl.Marker({ 
                            color: color,
                            scale: 1.5
                        })
                        .setLngLat([lng, lat])
                        .addTo(map);

                        // Create popup with property details
                        const popup = new mapboxgl.Popup({ offset: 25 })
                            .setHTML(`
                                <div style="padding: 8px; max-width: 250px;">
                                    <h3 style="margin: 0 0 8px 0; font-size: 14px;">${name}</h3>
                                    <p style="margin: 0;"><strong>Status:</strong> ${status}</p>
                                    <div style="margin: 8px 0; font-size: 11px;">
                                        <div>Lockbox: ${record.f3 === 'needed' ? 'ðŸ”´ Needed' : 'N/A'}</div>
                                        <div>Photos: ${record.f7 === 'needed' ? 'ðŸŸ¡ Needed' : 'N/A'}</div>
                                        <div>Eyes-On: ${record.f8 === 'needed' ? 'ðŸ”µ Needed' : 'N/A'}</div>
                                        <div>Banner: ${record.f5 === 'needed' ? 'ðŸŸ¢ Needed' : 'N/A'}</div>
                                    </div>
                                    <p style="margin: 4px 0 0 0; font-size: 10px; color: #666;">
                                        ${lat.toFixed(4)}, ${lng.toFixed(4)}
                                    </p>
                                </div>
                            `);

                        marker.setPopup(popup);
                        markersAdded++;
                        
                    } catch (error) {
                        console.error(`Error adding marker for record ${index + 1}:`, error);
                    }
                });
                
                debugDiv.textContent = `Loaded ${markersAdded} of ${validRecords} valid properties`;
                console.log(`Successfully added ${markersAdded} markers from ${records.length} records`);
                
                // Hide debug info after 5 seconds if successful
                if (markersAdded > 0) {
                    setTimeout(() => {
                        debugDiv.style.display = 'none';
                    }, 5000);
                }
                
            } catch (error) {
                console.error('Error loading properties:', error);
                debugDiv.textContent = 'Error loading properties - check console';
                debugDiv.style.background = '#ffebee';
                debugDiv.style.color = '#c62828';
            }
        }

        // Initialize map and load data
        map.on('load', function() {
            debugDiv.textContent = 'Map loaded. Loading properties...';
            console.log('Map loaded successfully');
            loadProperties();
        });

        // Error handling
        map.on('error', function(e) {
            console.error('Map error:', e);
            debugDiv.textContent = 'Map error - check console';
            debugDiv.style.background = '#ffebee';
            debugDiv.style.color = '#c62828';
        });
        
        // Auto-refresh every 5 minutes to get updated data
        setInterval(() => {
            console.log('Refreshing property data...');
            loadProperties();
        }, 300000); // 5 minutes
    </script>
</body>
</html>
