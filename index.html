<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>PPM Property Map - Live Data</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <style>
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        .mapboxgl-popup-content { font-size: 14px; max-width: 350px; }
        .loading { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000; text-align: center;
        }
        .refresh-btn {
            position: absolute; top: 10px; right: 10px; z-index: 1000;
            background: #007cbf; color: white; border: none; padding: 8px 12px;
            border-radius: 4px; cursor: pointer; font-size: 12px;
        }
        .refresh-btn:hover { background: #005a8b; }
        .legend {
            position: absolute; bottom: 30px; left: 10px; z-index: 1000;
            background: white; padding: 10px; border-radius: 6px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); font-size: 12px;
        }
        .legend-item { margin: 2px 0; display: flex; align-items: center; }
        .legend-color { width: 12px; height: 12px; border-radius: 50%; margin-right: 6px; }
    </style>
</head>
<body>
    <div id="loading" class="loading">
        <div>Loading property data...</div>
        <div style="margin-top: 8px; font-size: 12px; color: #666;">Connecting to Zapier Tables</div>
    </div>
    
    <button class="refresh-btn" onclick="refreshData()">üîÑ Refresh</button>
    
    <div class="legend">
        <strong>Property Status</strong>
        <div class="legend-item">
            <div class="legend-color" style="background: #ff0000;"></div>
            Lockbox Needed
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #ffff00; border: 1px solid #ccc;"></div>
            Photos Needed
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #0000ff;"></div>
            Eyes-On Needed
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #00ff00;"></div>
            Banner/Sign Needed
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #808080;"></div>
            Complete
        </div>
    </div>
    
    <div id="map"></div>
    
    <script>
        // Replace with your actual Mapbox token
        mapboxgl.accessToken = 'pk.eyJ1IjoiYnVuZHlrMTIiLCJhIjoiY21oY2NuZWMwMjEycDJucTMyM3B6dXJxZyJ9.eaWSaIsHytWE8odV_Lnhmg';
        
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v12',
            center: [-104.9903, 39.7392], // Denver coordinates
            zoom: 10
        });

        let markers = []; // Store markers for cleanup

        // Color coding function based on priority
        function getMarkerColor(lockbox, banner, photos, eyes) {
            if (lockbox === 'needed') return '#ff0000'; // Red - Highest priority
            if (photos === 'needed') return '#ffff00';  // Yellow
            if (eyes === 'needed') return '#0000ff';    // Blue
            if (banner === 'needed') return '#00ff00';  // Green
            return '#808080'; // Gray - Complete
        }

        // Get readable status text
        function getStatusText(value) {
            const statusMap = {
                'needed': 'Needs Action',
                'scheduled': 'Scheduled', 
                'completed': 'Completed',
                'na': 'N/A'
            };
            return statusMap[value] || value || 'Unknown';
        }

        // Clear existing markers
        function clearMarkers() {
            markers.forEach(marker => marker.remove());
            markers = [];
        }

        // Load properties from Zapier Tables API
        async function loadProperties() {
            try {
                document.getElementById('loading').style.display = 'block';
                
                // Using a CORS proxy to access Zapier Tables API
                const TABLE_ID = '01K8PPSAAZEMXCE2VHK4T6D9BY';
                
                // For production, you'll need to implement server-side API calls
                // This is a client-side demonstration with sample data that matches your table structure
                
                // Simulating API response with your table structure
                const response = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(`https://tables.zapier.com/api/v1/tables/${TABLE_ID}/records`)}`);
                
                let properties;
                if (response.ok) {
                    const data = await response.json();
                    // Parse the actual API response
                    properties = JSON.parse(data.contents).records || [];
                } else {
                    // Fallback to sample data if API fails
                    properties = getSampleData();
                }

                // Clear existing markers
                clearMarkers();
                
                let validProperties = 0;
                
                properties.forEach((record, index) => {
                    const property = record.fields || record;
                    
                    // Skip if no coordinates
                    if (!property.f11 || !property.f12) return;
                    
                    validProperties++;
                    
                    const color = getMarkerColor(
                        property.f3, // Lockbox status
                        property.f5, // Banner status  
                        property.f7, // Photos status
                        property.f8  // Eyes-on status
                    );

                    // Create marker
                    const marker = new mapboxgl.Marker({ 
                        color: color,
                        scale: 1.2 
                    })
                    .setLngLat([parseFloat(property.f12), parseFloat(property.f11)])
                    .addTo(map);

                    markers.push(marker); // Store for cleanup

                    // Format dates
                    const formatDate = (dateStr) => {
                        if (!dateStr) return 'Not set';
                        try {
                            return new Date(dateStr).toLocaleDateString();
                        } catch {
                            return dateStr;
                        }
                    };

                    // Create detailed popup
                    const popup = new mapboxgl.Popup({ 
                        offset: 25,
                        maxWidth: '350px'
                    })
                    .setHTML(`
                        <div style="padding: 8px;">
                            <h3 style="margin: 0 0 12px 0; font-size: 16px; color: #333; border-bottom: 1px solid #eee; padding-bottom: 6px;">
                                ${property.f1 || 'Unknown Address'}
                            </h3>
                            
                            ${property.f2 ? `<p style="margin: 0 0 10px 0; font-weight: bold;">üìç Unit: ${property.f2}</p>` : ''}
                            
                            <div style="margin: 12px 0; display: grid; gap: 4px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 4px 0;">
                                    <span><strong>üîí Lockbox:</strong></span>
                                    <span style="color: ${property.f3 === 'needed' ? '#ff0000' : '#008000'}; font-weight: bold;">
                                        ${getStatusText(property.f3)}
                                    </span>
                                </div>
                                
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 4px 0;">
                                    <span><strong>üè∑Ô∏è Banner/Sign:</strong></span>
                                    <span style="color: ${property.f5 === 'needed' ? '#00aa00' : '#008000'}; font-weight: bold;">
                                        ${getStatusText(property.f5)}
                                    </span>
                                </div>
                                
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 4px 0;">
                                    <span><strong>üì∏ Photos:</strong></span>
                                    <span style="color: ${property.f7 === 'needed' ? '#cc8800' : '#008000'}; font-weight: bold;">
                                        ${getStatusText(property.f7)}
                                    </span>
                                </div>
                                
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 4px 0;">
                                    <span><strong>üëÄ Eyes-on:</strong></span>
                                    <span style="color: ${property.f8 === 'needed' ? '#0000ff' : '#008000'}; font-weight: bold;">
                                        ${getStatusText(property.f8)}
                                    </span>
                                </div>
                            </div>
                            
                            ${property.f4 ? `<p style="margin: 8px 0 4px 0; font-size: 12px;"><strong>Lockbox Date:</strong> ${formatDate(property.f4)}</p>` : ''}
                            
                            <div style="margin: 10px 0; padding: 8px; background: #f8f9fa; border-radius: 4px;">
                                <p style="margin: 0; font-size: 12px;"><strong>Priority:</strong> 
                                   <span style="text-transform: uppercase; font-weight: bold; color: ${
                                       property.f9 === 'urgent' ? '#ff0000' : 
                                       property.f9 === 'high' ? '#ff6600' : 
                                       property.f9 === 'medium' ? '#ffaa00' : '#008000'
                                   };">${property.f9 || 'N/A'}</span>
                                </p>
                                <p style="margin: 4px 0 0 0; font-size: 11px; color: #666;">
                                    Coords: ${parseFloat(property.f11).toFixed(6)}, ${parseFloat(property.f12).toFixed(6)}
                                </p>
                            </div>
                            
                            ${property.f10 ? `<p style="margin: 8px 0 4px 0; font-size: 12px; color: #666; font-style: italic; border-top: 1px solid #eee; padding-top: 6px;">"${property.f10}"</p>` : ''}
                            
                            <p style="margin: 6px 0 0 0; font-size: 10px; color: #999; text-align: right;">
                                Updated: ${formatDate(property.f13)}
                            </p>
                        </div>
                    `);

                    marker.setPopup(popup);
                });

                document.getElementById('loading').style.display = 'none';
                
                // Fit map to show all markers if we have properties
                if (validProperties > 0) {
                    const coordinates = properties
                        .filter(record => {
                            const property = record.fields || record;
                            return property.f11 && property.f12;
                        })
                        .map(record => {
                            const property = record.fields || record;
                            return [parseFloat(property.f12), parseFloat(property.f11)];
                        });
                    
                    if (coordinates.length > 1) {
                        const bounds = coordinates.reduce((bounds, coord) => {
                            return bounds.extend(coord);
                        }, new mapboxgl.LngLatBounds(coordinates[0], coordinates[0]));
                        
                        map.fitBounds(bounds, { padding: 60 });
                    } else if (coordinates.length === 1) {
                        map.setCenter(coordinates[0]);
                        map.setZoom(12);
                    }
                }

                console.log(`Loaded ${validProperties} properties with coordinates`);

            } catch (error) {
                console.error('Error loading properties:', error);
                document.getElementById('loading').innerHTML = `
                    <div style="color: #ff0000;">‚ö†Ô∏è Error loading data</div>
                    <div style="font-size: 12px; margin-top: 4px;">Using sample data instead</div>
                `;
                
                // Load sample data as fallback
                setTimeout(() => {
                    loadSampleData();
                }, 2000);
            }
        }

        // Sample data matching your table structure
        function getSampleData() {
            return [
                {
                    fields: {
                        f1: '1234 E 17th Ave, Denver, CO 80218',
                        f2: 'Unit A',
                        f3: 'needed',      // Lockbox
                        f4: '2025-10-30',  // Lockbox Date
                        f5: 'completed',   // Banner
                        f7: 'needed',      // Photos
                        f8: 'completed',   // Eyes-on
                        f9: 'high',        // Priority
                        f10: 'Property needs lockbox removal and exterior photos taken',
                        f11: 39.7391536,   // Latitude
                        f12: -104.9847034, // Longitude
                        f13: '2025-10-29T19:00:00Z'
                    }
                },
                {
                    fields: {
                        f1: '2550 Washington St, Denver, CO 80205',
                        f2: '',
                        f3: 'completed',
                        f4: '2025-10-28',
                        f5: 'needed',
                        f7: 'completed',
                        f8: 'needed',
                        f9: 'medium',
                        f10: 'Banner removal and drive-by inspection needed',
                        f11: 39.7530556,
                        f12: -104.9802778,
                        f13: '2025-10-29T18:30:00Z'
                    }
                }
            ];
        }

        // Load sample data fallback
        function loadSampleData() {
            const sampleData = getSampleData();
            clearMarkers();
            
            sampleData.forEach(record => {
                const property = record.fields;
                const color = getMarkerColor(property.f3, property.f5, property.f7, property.f8);
                
                const marker = new mapboxgl.Marker({ color: color, scale: 1.2 })
                    .setLngLat([property.f12, property.f11])
                    .addTo(map);
                markers.push(marker);
            });
            
            document.getElementById('loading').style.display = 'none';
        }

        // Refresh function for manual updates
        function refreshData() {
            console.log('Refreshing property data...');
            loadProperties();
        }

        // Initialize map
        map.on('load', loadProperties);

        // Auto-refresh every 10 minutes
        setInterval(loadProperties, 10 * 60 * 1000);
    </script>
</body>
</html>
